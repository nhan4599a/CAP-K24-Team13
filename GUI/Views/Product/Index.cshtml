<style>
    .pagesize {
        position: absolute;
        display: inline-flex;
        margin-top: -10px;
        right: 25%
    }
</style>
<div class="pagesize">
    <p style="margin-bottom: 0; width:150px; margin-top: 20px">Page size:</p>
    <select class="form-control" style="border: 1px solid #000; padding: 5px 0 5px 10px; margin-top: 15px;">
        <option value="">5 items</option>
        <option value="all">10 items</option>
        <option value="selected">15 items</option>
    </select>
</div>  

<div class="row">
    <div class="col-12">
        <a href="/product/add" class="btn btn-primary">Add</a>
        <div class="card my-4">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                    <h6 class="text-white text-capitalize ps-3">Products table</h6>
                </div>
            </div>
            <div class="card-body px-0 pb-2">
                <div class="table-responsive p-0"></div>
            </div>
        </div>
    </div>
</div>
<div class="pagination">
</div>
@section Scripts {
    <script>
        $(document).ready(() => {
            var currentPageInfo = getCurrentPageInfo();
            loadProducts(currentPageInfo.keyword, currentPageInfo.pageNumber, currentPageInfo.pageSize);
            let classNames = ['active', 'bg-gradient-primary'];
            $('#nav-item-product').addClass(classNames);
            var searchTextField = $('#input-search');
            if (currentPageInfo.keyword) {
                searchTextField.parent().addClass('is-filled');
                searchTextField.val(currentPageInfo.keyword);
            }
            searchTextField.keypress(function (e) {
                if (e.which == 13) {
                    e.preventDefault();
                    var keyword = $(this).val().trim();
                    var currentPageSize = getCurrentPageInfo().pageSize;
                    window.location.href =
                        `https://localhost:44349/product?keyword=${encodeURIComponent(keyword)}&paginationInfo.pageNumber=1&paginationInfo.pageSize=${currentPageSize}`;
                }
            });
        });

        function loadProducts(keyword, pageNumber, pageSize) {
            $.get('https://localhost:44302/api/products', {
                keyword: keyword,
                "paginationInfo.pageNumber": pageNumber,
                "paginationInfo.pageSize": pageSize || 5
            },
                (res) => {
                    var paginationResult = res.data;
                    var products = paginationResult.data;
                    var tableHtml = '';
                    var paginationHtml = '';
                    if (products.length == 0) {
                        tableHtml = '<p style="text-align: center">There is no product to show!</p>'
                    } else {
                        var dataRowHtml = '';
                        if (pageNumber != 1)
                            paginationHtml += '<a href="#" id="previous-page">«</a>';
                        for (var i = 1; i <= paginationResult.maxPageNumber; i++) {
                            if (i == pageNumber)
                                paginationHtml += `<a class="active">${i}</a>`;
                            else
                                paginationHtml += `<a class="pagination-item">${i}</a>`;
                        }
                        if (pageNumber != paginationResult.maxPageNumber)
                            paginationHtml += '<a href="#" id="next-page">»</a>';
                        products.forEach((product, index) => {
                            dataRowHtml += `<tr>
                                                        <td style="display: none" id="prod-id">${product.id}</td>
                                                        <td class="align-middle text-center" style="padding: 0;">${index + 1}</td>
                                                        <td class="align-middle text-center">
                                                            <div class="d-flex px-2 py-1">
                                                                <div>
                                                                    <img src="../assets/img/team-2.jpg"
                                                                        class="avatar avatar-sm me-3 border-radius-lg" alt="user1">
                                                                </div>
                                                                <div class="d-flex flex-column">
                                                                    <h6 class="mb-0 text-sm">${product.productName}</h6>
                                                                    <p class="text-xs text-secondary mb-0" style="text-align: left">${product.categoryName}</p>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="align-middle text-center">
                                                            <span class="text-secondary text-xs font-weight-bold">${product.price}đ</span>
                                                        </td>
                                                        <td class="align-middle text-center text-sm">
                                                            <span class="badge badge-sm bg-gradient-${!product.isDisabled ? 'success' : 'secondary'}">
                                                                ${!product.isDisabled ? 'Active' : 'Disabled'}
                                                            </span>
                                                        </td>
                                                        <td class="align-middle">
                                                            <a href="#" class="text-secondary font-weight-bold text-xs"
                                                                data-toggle="tooltip" data-original-title="Edit user" style="margin-right: 24px" name="btn-edit">
                                                                    <i class="far fa-edit"></i><span> Edit</span>
                                                            </a>
                                                            ${!product.isDisabled ?
                                    `       <a href="#" class="text-secondary font-weight-bold text-xs"
                                                                    data - toggle="tooltip" data - original - title="Delete user" name = "btn-delete">
                                                                        <i class="far fa-trash-alt"></i><span> Delete</span>
                                                                </a>` : ''}
                                                        </td>
                                                    </tr>`;
                        });
                        tableHtml = `<table class="table align-items-center mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                                                            style="width: 50px; min-width: 50px !important;">
                                                                #
                                                        </th>
                                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                                                            style="padding-left: 24px!important">
                                                                Name
                                                        </th>
                                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                                            Price
                                                        </th>
                                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                                            Status
                                                        </th>
                                                        <th class="text-secondary opacity-7">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${dataRowHtml}
                                                </tbody>
                                            </table>`;
                    }
                    $('.table-responsive.p-0').html(tableHtml);
                    $('.pagination').html(paginationHtml);
                    $('a[name=btn-edit]').click(function (e) {
                        e.preventDefault();
                        var index = parseInt($(this).parent().parent().children('td:nth-child(2)').text()) - 1;
                        var productInfoStr = JSON.stringify(products[index]);
                        window.localStorage.setItem('editting-product', productInfoStr);
                        window.location.href = "/product/edit";
                    });
                    $('a[name=btn-delete]').click(function (e) {
                        let id = $(this).parent().parent().children('#prod-id').text();
                        if (!confirm(`Are you sure to product with id = ${id}`))
                            return;
                        e.preventDefault();
                        $.ajax('https://localhost:44302/api/products', {
                            method: 'DELETE',
                            contentType: 'application/json',
                            data: JSON.stringify(id),
                            success: (res) => {
                                if (res.responseCode != 200) {
                                    toastr.error(`Failed to delete product with id = ${id}, ${res.errorMessage}!`, 'Error');
                                } else {
                                    toastr.success(`Deleted product with id = ${id}`, 'Success');
                                    $(this).parent().parent().children('td:nth-child(5)').children()
                                        .removeClass('bg-gradient-success')
                                        .addClass('bg-gradient-secondary')
                                        .text('Disabled');
                                    $(this).remove();
                                }
                            }
                        });
                    });
                    $('#previous-page').click(() => {
                        var currentPageInfo = getCurrentPageInfo();
                        moveToPage(currentPageInfo.keyword, currentPageInfo.pageNumber - 1, currentPageInfo.pageSize);
                    });
                    $('#next-page').click(() => {
                        var currentPageInfo = getCurrentPageInfo();
                        moveToPage(currentPageInfo.keyword, currentPageInfo.pageNumber + 1, currentPageInfo.pageSize);
                    });
                    $('a.pagination-item').click(function () {
                        var pageNumber = $(this).text();
                        var currentPageInfo = getCurrentPageInfo();
                        moveToPage(currentPageInfo.keyword, pageNumber, currentPageInfo.pageSize);
                    });
                }
            );
        }

        function moveToPage(keyword, pageNumber, pageSize) {
            if (keyword == '')
                window.location.href = `https://localhost:44349/product?pageNumber=${pageNumber}&pageSize=${pageSize}`;
            else
                window.location.href = `https://localhost:44349/product?keyword=${keyword}&pageNumber=${pageNumber}&pageSize=${pageSize}`;
        }

        function getCurrentPageInfo() {
            var url = new URL(window.location.href);
            var queryObj = url.searchParams;
            var currentPageNumber = queryObj.get('pageNumber') ? parseInt(queryObj.get('pageNumber')) : 1;
            var currentPageSize = queryObj.get('pageSize') ? parseInt(queryObj.get('pageSize')) : 5;
            var currentKeyword = queryObj.get('keyword') ? queryObj.get('keyword') : '';
            return {
                pageNumber: currentPageNumber,
                pageSize: currentPageSize,
                keyword: currentKeyword
            };
        }
    </script>
}
